<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ITALIACCIAI - ØªØ³Ø¬ÙŠÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#000;
  color:#ffd700;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.box{
  width:100%;
  max-width:360px;
  padding:25px;
  background:rgba(0,0,0,0.9);
  border-radius:20px;
  border:2px solid #ffd70055;
  box-shadow:0 0 25px #ffd70077;
  text-align:center;
}
h2{margin-bottom:20px;}
input,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:12px;
  border:none;
  font-size:15px;
}
input{
  background:#111;
  color:#ffd700;
  border:1px solid #ffd70055;
}
button{
  background:#ffd700;
  color:#000;
  font-weight:bold;
  cursor:pointer;
}
#error{
  margin-top:12px;
  color:#ff4d4d;
}
</style>
</head>

<body>

<div class="box">
  <h2>ğŸ” ITALIACCIAI</h2>

  <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
  <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
  <input id="invite" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¯Ø¹ÙˆØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">

  <button onclick="signup()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>

  <div id="error"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } 
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, query, where, getDocs } 
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* ğŸ”¥ Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAa6ETi1DmEI-3nVuqjpsaodT0rXsP8bIw",
  authDomain: "aple-21978.firebaseapp.com",
  projectId: "aple-21978",
  storageBucket: "aple-21978.firebasestorage.app",
  messagingSenderId: "1013598113300",
  appId: "1:1013598113300:web:5e71138b4e75e2a2752101"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const errorEl = document.getElementById("error");

/* ğŸ“± ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‡Ø§ØªÙ Ù„Ø¥ÙŠÙ…ÙŠÙ„ */
function phoneToEmail(phone){
  return phone + "@total.fake";
}

/* ğŸ”’ Device ID */
let deviceId = localStorage.getItem("deviceId");
if(!deviceId){
  deviceId = crypto.randomUUID();
  localStorage.setItem("deviceId", deviceId);
}

/* â­â­â­ Ø¬Ù„Ø¨ Ø±Ù…Ø² Ø§Ù„Ø¯Ø¹ÙˆØ© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· â­â­â­ */
const params = new URLSearchParams(window.location.search);
const refCode = params.get("ref");
if(refCode){
  document.getElementById("invite").value = refCode;
}

/* âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ */
window.signup = async () => {
  try{
    const phone = document.getElementById("phone").value.trim();
    const pass  = document.getElementById("password").value.trim();
    const inviteInput = document.getElementById("invite").value.trim();

    if(!phone || !pass){
      errorEl.textContent="âŒ Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„";
      return;
    }

    let joinedBy = null;

    if(inviteInput){
      const q = query(
        collection(db,"users"),
        where("inviteCode","==",inviteInput)
      );
      const snap = await getDocs(q);
      if(snap.empty){
        errorEl.textContent="âŒ Ø±Ù…Ø² Ø§Ù„Ø¯Ø¹ÙˆØ© ØºÙŠØ± ØµØ­ÙŠØ­";
        return;
      }
      joinedBy = inviteInput;
    }

    const email = phoneToEmail(phone);
    const cred = await createUserWithEmailAndPassword(auth,email,pass);

    await setDoc(doc(db,"users",cred.user.uid),{
      phone,
      joinedBy,
      balance: 0,
      level: 0,
      deviceId,
      createdAt: Date.now()
    });

    location.href="index.html";

  }catch(e){
    errorEl.textContent="âŒ "+e.message;
  }
};

/* ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ */
window.login = async () => {
  try{
    const phone = document.getElementById("phone").value.trim();
    const pass  = document.getElementById("password").value.trim();

    if(!phone || !pass){
      errorEl.textContent="âŒ Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„";
      return;
    }

    const email = phoneToEmail(phone);
    await signInWithEmailAndPassword(auth,email,pass);
    location.href="index.html";

  }catch(e){
    errorEl.textContent="âŒ "+e.message;
  }
};
</script>

</body>
</html>