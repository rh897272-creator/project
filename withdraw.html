<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ITALIACCIAI - Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body{
  margin:0;
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#000,#1a1400,#332200);
  color:#ffd700;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card{
  width:460px;
  background:rgba(0,0,0,0.85);
  border:3px solid #ffd70055;
  border-radius:35px;
  padding:30px 25px;
  box-shadow:0 0 40px #ffd70077, inset 0 0 20px #ffd70033;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.balance{ margin:12px 0; font-weight:bold; font-size:18px; }
.input-group{ margin-bottom:15px; width:100%; }
input{
  width:100%; padding:12px; border-radius:15px;
  border:none; background:#222; color:#ffd700; font-size:16px;
}
button{
  width:70%; padding:15px; border:none; border-radius:20px;
  background:linear-gradient(145deg,#111,#222);
  color:#ffd700; font-weight:bold; font-size:18px; cursor:pointer;
}
button:disabled{ opacity:.5; cursor:not-allowed; }
.status{ margin-top:10px; font-weight:bold; text-align:center; min-height:22px; }
.history{
  margin-top:15px; width:100%;
  background:rgba(0,0,0,0.6);
  padding:12px; border-radius:15px;
  max-height:180px; overflow:auto;
}
</style>
</head>
<body>

<div class="card">
  <h2>ğŸ’¸ ITALIACCIAI - Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯</h2>
  <div class="balance" id="balanceBox">Ø§Ù„Ø±ØµÙŠØ¯: 0 Ø¯Ø¬</div>

  <div class="input-group">
    <input type="number" id="amount" placeholder="ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 1000 Ø¯Ø¬)">
  </div>
  <div class="input-group">
    <input type="text" id="account" placeholder="ğŸ¦ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨">
  </div>
  <div class="input-group">
    <input type="password" id="pin" placeholder="ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
  </div>

  <button id="withdraw">Ø³Ø­Ø¨ Ø§Ù„Ø¢Ù†</button>
  <div class="status" id="status">Ø¬Ø§Ù‡Ø²</div>
  <div class="history" id="history">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAa6ETi1DmEI-3nVuqjpsaodT0rXsP8bIw",
  authDomain: "aple-21978.firebaseapp.com",
  projectId: "aple-21978",
  storageBucket: "aple-21978.firebasestorage.app",
  messagingSenderId: "1013598113300",
  appId: "1:1013598113300:web:5e71138b4e75e2a2752101"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let uid=null, balance=0, totalDeposit=0;
const balanceBox=document.getElementById("balanceBox");
const statusBox=document.getElementById("status");
const historyBox=document.getElementById("history");
const withdrawBtn=document.getElementById("withdraw");

onAuthStateChanged(auth, async user=>{
  if(!user){ window.location.href="login.html"; return; }
  uid=user.uid;
  await loadUser();
  loadHistory();
  checkWithdrawAvailability();
});

async function loadUser(){
  const ref=doc(db,"users",uid);
  const snap=await getDoc(ref);
  if(snap.exists()){
    balance = snap.data().balance || 0;
    totalDeposit = snap.data().totalDeposit || 0;
  }
  balanceBox.textContent = `Ø§Ù„Ø±ØµÙŠØ¯: ${balance} Ø¯Ø¬`;
}

function checkWithdrawAvailability(){
  const day=new Date().getDay();
  const hour=new Date().getHours();

  if(totalDeposit <= 0){
    withdrawBtn.disabled=true;
    statusBox.textContent="ğŸ”’ Ø§Ù„Ø³Ø­Ø¨ Ù…ØªØ§Ø­ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹";
    return;
  }
  if(day===5){
    withdrawBtn.disabled=true;
    statusBox.textContent="ğŸ“Œ Ø§Ù„Ø³Ø­Ø¨ Ù…ØªÙˆÙ‚Ù ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©";
    return;
  }
  if(hour<8 || hour>17){
    withdrawBtn.disabled=true;
    statusBox.textContent="â° Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† 08:00 Ø¥Ù„Ù‰ 17:00";
    return;
  }
  withdrawBtn.disabled=false;
  statusBox.textContent="Ø¬Ø§Ù‡Ø²";
}

setInterval(checkWithdrawAvailability,30000);

withdrawBtn.onclick=async()=>{
  if(withdrawBtn.disabled) return;

  const amount=Number(amountInput.value);
  const account=accountInput.value;
  const pin=pinInput.value;

  if(!amount||!account||!pin){ statusBox.textContent="âŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù†Ø§Ù‚ØµØ©"; return; }
  if(amount<1000){ statusBox.textContent="âŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 1000 Ø¯Ø¬"; return; }
  if(amount>balance){ statusBox.textContent="ğŸ’¸ Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ"; return; }

  await addDoc(collection(db,"withdraws"),{
    uid, amount, account, pin,
    status:"Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©",
    createdAt:serverTimestamp()
  });

  balance-=amount;
  await updateDoc(doc(db,"users",uid),{balance});
  balanceBox.textContent=`Ø§Ù„Ø±ØµÙŠØ¯: ${balance} Ø¯Ø¬`;
  statusBox.textContent="âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨";

  amountInput.value="";
  accountInput.value="";
  pinInput.value="";
};

function loadHistory(){
  const q=query(collection(db,"withdraws"), where("uid","==",uid));
  onSnapshot(q,snap=>{
    let html="";
    snap.forEach(d=>{
      const x=d.data();
      if(x.createdAt){
        html+=`ğŸ’° ${x.amount} Ø¯Ø¬ â€“ ${x.status}<br>ğŸ•’ ${x.createdAt.toDate().toLocaleString()}<hr>`;
      }
    });
    historyBox.innerHTML = html || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª";
  });
}

const amountInput=document.getElementById("amount");
const accountInput=document.getElementById("account");
const pinInput=document.getElementById("pin");
</script>

</body>
</html>
